---
  # Title: ansible-role-guacamole
  #
  # Author: Luc Rutten
  # File tasks/main2.yml
  #
  # Description:
  #   Apache Guacamole is a clientless remote desktop gateway.
  #
  # Depends on: 
  #   MySQL 5.7
  
  - name: "Create ansible and guacamole directory structure"
    file:
      path: "{{ item }}"
      state: directory
    with_items:
      - /opt/ansible
      - /opt/ansible/projects
      - /opt/ansible/projects/guacamole
      - /opt/ansible/projects/guacamole/scripts
      - /opt/ansible/projects/guacamole/resources
      - /etc/guacamole
      - /etc/guacamole/lib
      - /etc/guacamole/extensions
      - /usr/share/tomcat8
      - /usr/share/tomcat8/.guacamole
      
  - name: "Install packages"
    apt:
      name: "{{ item }}"
      update_cache: yes
      state: present
    with_items:
  - name: "Install packages"
    apt:
      name: "{{ item }}"
      update_cache: yes
      state: present
    with_items:
      - build-essential 
      - gcc-6
      - g++-6
      - libcairo2-dev
      - libjpeg-turbo8-dev
#      - libpng12-dev
      - libpng-dev
      - libossp-uuid-dev
      - libavcodec-dev
      - libavutil-dev
      - libswscale-dev
      - libfreerdp-dev
      - libpango1.0-dev
      - libssh2-1-dev
      - libtelnet-dev
      - libvncserver-dev
      - libpulse-dev
      - libssl-dev
      - libvorbis-dev
      - libwebp-dev
      - tomcat8 
      - freerdp-x11
      - ghostscript
      - jq
 #     - wget
 #     - curl
      - haveged
      
  - name: "stop tomcat service"
    systemd:
      name: tomcat8
      state: stopped

  - name: "Transfer templates files to the specified directories"
    template:
      src: "{{ item.src }}"
      dest: "{{ item.dst }}"
      backup: yes
    with_items:
      - { src: 'tomcat8.j2', dest: '/etc/default/tomcat8' }
      - { src: 'guacamole.properties.j2', dest: '/etc/guacamole/guacamole.properties' }

  - name: "Create symlink from /etc/guacamole/guacamole.properties to /usr/share/tomcat8/.guacamole/guacamole.properties"
    file:
      src: /etc/guacamole/guacamole.properties
      dest: /usr/share/tomcat8/.guacamole/guacamole.properties
      state: link    
      
  - name: "Download guacamole server and client files"
    get_url:
      url: "{{ item.src }}"
      dest: "{{ item.dst }}"
    with_items:
      - { src: '{{ guac_server_src }}', dst: '{{ guac_server_dir }}' }
      - { src: '{{ guac_client_src }}', dst: '{{ guac_client_dst }}' }

  - name: "Unarchive guacamole server files"
    unarchive: 
      src: "{{ guac_server_dir }}/{{ guac_server_tar }}"
      dest: "{{ guac_server_dir_unpacked }}"
      remote_src: yes
 
    - name: "Create initial Guacamole MySQL database"
    mysql_db:
      name: "{{ guac_dbname }}"
      encoding: utf8
      state: present
      login_user: "{{ MySQL_ROOT_ACCOUNT }}"
      login_password: "{{ MySQL_ROOT_PASSWORD }}"

  - name: "Create Guacamole MySQL database user"
    mysql_user:
      name: "{{ guac_dbuser }}"
      password: "{{ guac_dbpass }}"
      priv: "{{ guac_dbname }}.*:ALL,GRANT"
      state: present
      login_user: "{{ MySQL_ROOT_ACCOUNT }}"
      login_password: "{{ MySQL_ROOT_PASSWORD }}"
      
  - name: "Transfer compile.sh.j2 template to {{ guac_server_dir_unpack }}/compile.sh"
    template:
      src: compile.sh.j2
      dest: "{{ guac_server_dir_unpack }}/compile.sh"
      mode: 0755
  
  - name: "Execute compile.sh"
    raw: sudo bash "{{ guac_server_dir_unpack }}/compile.sh"
  
  - name: "Download and unarchive files connectors"
    unarchive:
      url: "{{ item.src }}"
      dest: "{{ item.dst }}"
      remote_src: yes
    with_items:
      - { src: '{{ guac_mysql_conn_src }}', dest: '{{ guac_mysql_conn_dst }}' }
#      - { src: '{{ guac_mysql_conn_java_src }}', dest: '{{ guac_mysql_conn_java_dst }}' }
      - { src: '{{ guac_ldap_conn_src }}', dest: '{{ guac_ldap_conn_dst }}' }

  - name: "Download and unarchive files connectors"      
    apt:
      deb: "{{ guac_mysql_conn_java_src }}"
      

  - name: "Restart guac en tomcat8 services"
    systemd:
      name: "{{ item }}"
      state: restarted
      enabled: yes
    with_items:
      - guacd
      - tomcat8
      
